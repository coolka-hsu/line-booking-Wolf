<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>æŸ¥è©¢æˆ‘çš„è¨‚ä½</title>
  <style>
    body {
      font-family: 'Noto Sans TC', sans-serif;
      background-color: #f5f5f5;
      padding: 2rem;
      color: #333;
    }
    h1 { font-size: 1.8rem; margin-bottom: 1rem; }
    form {
      background: #fff; padding: 1.5rem; border-radius: 10px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1); max-width: 520px; margin: 0 auto 1rem;
    }
    label { display: block; margin-top: 0.5rem; font-weight: bold; }
    input[type="tel"]{
      width: 100%; padding: 0.5rem; margin-top: 0.3rem;
      border: 1px solid #ccc; border-radius: 5px;
    }
    button {
      margin-top: 1rem; padding: 0.7rem 1.2rem; background-color: #4CAF50;
      color: #fff; border: none; border-radius: 5px; cursor: pointer; font-size: 1rem;
    }
    .error { color: #d93025; margin-top: 0.8rem; }
    .muted { color: #666; font-size: .95rem; }
    .panel, .result {
      max-width: 760px; margin: 1rem auto; background: #fff; padding: 1.2rem;
      border-radius: 10px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    .cards { display: grid; grid-template-columns: repeat(auto-fill, minmax(320px, 1fr)); gap: 12px; }
    .card { border: 1px solid #eee; border-radius: 10px; padding: 12px; }
    .row { margin: .35rem 0; }
    .label { color:#555; display:inline-block; min-width: 6.5em; }
    .badge { display:inline-block; padding:2px 8px; border-radius:999px; background:#f0f0f0; font-size:.85rem; }
    .actions { display:flex; gap:.6rem; flex-wrap:wrap; margin-top:.6rem; }
    .link-btn {
      display:inline-block; padding:.5rem .8rem; border-radius:8px; text-decoration:none;
      background:#efefef;
    }
  </style>
</head>
<body>
  <h1>ğŸ” æŸ¥è©¢æˆ‘çš„è¨‚ä½</h1>

  <form id="searchForm">
    <div class="muted" id="loadState">è³‡æ–™è¼‰å…¥ä¸­â€¦</div>

    <label for="phone">æ‰‹æ©Ÿè™Ÿç¢¼ï¼š</label>
    <input type="tel" id="phone" placeholder="è«‹è¼¸å…¥æ‚¨çš„å®Œæ•´æ‰‹æ©Ÿè™Ÿç¢¼ï¼ˆç¬¦è™Ÿå¯ç•¥ï¼‰" required />

    <button type="submit">æŸ¥è©¢</button>
    <div class="error" id="error"></div>
  </form>

  <div class="result" id="result" style="display:none;"></div>

  <script>
    const DATA_URL = 'https://coolka-hsu.github.io/line-booking-Wolf/search_data.json';
    const CAL_TITLE = 'åŒ—å®œ32K è¨‚ä½æé†’';
    const CAL_DETAILS = 'ğŸ“Œ é˜¿ç¾©æé†’æ‚¨ï¼šé€™æ˜¯æ‚¨åœ¨ã€åŒ—å®œ32K ç‹¼ä¾†äº†ç¢³çƒ¤ç¾Šè…¿ã€‘çš„è¨‚ä½ã€‚å»ºè­°æå‰æŠµé”ï¼ğŸ”” æé†’å»ºè­°ï¼šè«‹å°‡é è¨­çš„ã€Œæå‰10åˆ†é˜é€šçŸ¥ã€æ”¹ç‚ºã€Œæå‰ï¼’å¤©é€šçŸ¥ã€ï¼';
    const CAL_LOCATION = '232æ–°åŒ—å¸‚åªæ—å€åŒ—å®œå…¬è·¯ä¸ƒæ®µ32K';
    let allData = [];

    const loadStateEl = document.getElementById('loadState');
    const errorEl = document.getElementById('error');
    const resultEl = document.getElementById('result');

    // åªå–æ•¸å­—ï¼Œå…è¨±ä½¿ç”¨è€…è¼¸å…¥ 0912-345-678 / 0912345678 / 0912 345 678
    function normalizePhone(str) {
      return (str || '').replace(/\D+/g, '');
    }

    // è§£æã€ŒYYYY/MM/DDã€èˆ‡ã€ŒHH:mmã€æˆ–ã€Œä¸Šåˆ/ä¸‹åˆ h:mmã€â†’ å›å‚³ Date
    function parseDateTime(dateStr, timeStr) {
      // date: 2025/10/13 æˆ– 2025-10-13
      const m = dateStr.trim().replace(/-/g,'/').match(/^(\d{4})\/(\d{1,2})\/(\d{1,2})$/);
      if (!m) return null;
      let [_, y, mo, d] = m;
      y = +y; mo = +mo; d = +d;

      let h = 0, min = 0;
      const t = timeStr.trim();

      // æ”¯æ´ã€Œä¸Šåˆ/ä¸‹åˆã€èˆ‡ã€ŒAM/PMã€
      const zh = t.match(/^(ä¸Šåˆ|ä¸‹åˆ)\s*(\d{1,2})(?::(\d{2}))?$/);
      const en = t.match(/^(\d{1,2})(?::(\d{2}))?\s*(AM|PM)$/i);
      const plain = t.match(/^(\d{1,2}):(\d{2})$/);

      if (zh) {
        h = +zh[2]; min = +(zh[3] || 0);
        if (zh[1] === 'ä¸‹åˆ' && h < 12) h += 12;
        if (zh[1] === 'ä¸Šåˆ' && h === 12) h = 0;
      } else if (en) {
        h = +en[1]; min = +(en[2] || 0);
        const ap = en[3].toUpperCase();
        if (ap === 'PM' && h < 12) h += 12;
        if (ap === 'AM' && h === 12) h = 0;
      } else if (plain) {
        h = +plain[1]; min = +plain[2];
      } else {
        // æœ€å¾Œå˜—è©¦ Date è§£æï¼ˆå¯èƒ½ä¸ä¸€è‡´ï¼‰
        const dt = new Date(`${y}/${mo}/${d} ${t}`);
        if (!isNaN(dt)) return dt;
        return null;
      }

      return new Date(y, mo - 1, d, h, min, 0, 0);
    }

    // æ ¼å¼ï¼šYYYYMMDDTHHmmss
    function fmtICS(dt) {
      const pad = n => String(n).padStart(2, '0');
      return `${dt.getFullYear()}${pad(dt.getMonth()+1)}${pad(dt.getDate())}T${pad(dt.getHours())}${pad(dt.getMinutes())}00`;
    }

    // å»º Google Calendar é€£çµï¼ˆ2.5 å°æ™‚è¡Œç¨‹ï¼‰
    function createGCalLink(date, time) {
      const startDt = parseDateTime(date, time);
      if (!startDt) return '#';
      const endDt = new Date(startDt.getTime() + 2.5 * 60 * 60 * 1000);

      const params = new URLSearchParams({
        text: CAL_TITLE,
        dates: `${fmtICS(startDt)}/${fmtICS(endDt)}`,
        details: CAL_DETAILS,
        location: CAL_LOCATION
      });
      return `https://calendar.google.com/calendar/r/eventedit?${params.toString()}`;
    }

    // ä¸‹è¼‰ .icsï¼ˆçµ¦é Google Calendar ä½¿ç”¨è€…ï¼‰
    function downloadICS(item) {
      const startDt = parseDateTime(item.date, item.time);
      if (!startDt) return;
      const endDt = new Date(startDt.getTime() + 2.5 * 60 * 60 * 1000);

      const lines = [
        'BEGIN:VCALENDAR',
        'VERSION:2.0',
        'PRODID:-//Booking Lookup//TW',
        'CALSCALE:GREGORIAN',
        'METHOD:PUBLISH',
        'BEGIN:VEVENT',
        `UID:${crypto.randomUUID()}`,
        `DTSTAMP:${fmtICS(new Date())}`,
        `DTSTART:${fmtICS(startDt)}`,
        `DTEND:${fmtICS(endDt)}`,
        `SUMMARY:${CAL_TITLE}`,
        `DESCRIPTION:${CAL_DETAILS}`,
        `LOCATION:${CAL_LOCATION}`,
        'END:VEVENT',
        'END:VCALENDAR'
      ];
      const blob = new Blob([lines.join('\r\n')], { type: 'text/calendar;charset=utf-8' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `booking_${item.date}_${item.time}.ics`;
      a.click();
      URL.revokeObjectURL(url);
    }

    // æ¸²æŸ“å¤šç­†çµæœ
    function renderResults(items, phone) {
      const normalized = normalizePhone(phone);
      resultEl.innerHTML = '';
      resultEl.style.display = 'block';

      const header = document.createElement('div');
      header.className = 'panel';
      header.innerHTML = `<div><strong>æŸ¥è©¢é–€è™Ÿï¼š</strong>${normalized}ã€€<span class="badge">å…± ${items.length} ç­†</span></div>`;
      resultEl.appendChild(header);

      const wrap = document.createElement('div');
      wrap.className = 'cards';

      items.forEach(it => {
        const card = document.createElement('div');
        card.className = 'card';
        card.innerHTML = `
          <div class="row"><span class="label">ğŸ“… è¨‚ä½æ—¥æœŸï¼š</span>${it.date}</div>
          <div class="row"><span class="label">â° ç”¨é¤æ™‚æ®µï¼š</span>${it.time}</div>
          <div class="row"><span class="label">ğŸ§‘ è¨‚ä½å¤§åï¼š</span>${it.display_name || ''} å…ˆç”Ÿ/å°å§</div>
          <div class="row"><span class="label">ğŸ™â€â™‚ï¸ LINEåç¨±ï¼š</span>${it.line_name || ''}</div>
          <div class="row"><span class="label">ğŸ“ æ‰‹æ©Ÿè™Ÿç¢¼ï¼š</span>${it.phone}</div>
          <div class="row"><span class="label">ğŸ‘¨â€ğŸ‘©â€ğŸ‘§â€ğŸ‘¦ äººæ•¸ï¼š</span>${it.people}</div>
          <div class="row"><span class="label">ğŸ“ å‚™è¨»ï¼š</span>${it.note || 'ç„¡'}</div>
          <div class="actions">
            <a class="link-btn" href="${createGCalLink(it.date, it.time)}" target="_blank">ğŸ“† åŠ åˆ° Google æ—¥æ›†</a>
            <a class="link-btn" href="javascript:void(0)" data-ics="1">ğŸ“¥ ä¸‹è¼‰ .ics</a>
          </div>
        `;
        // ç¶å®š .ics
        card.querySelector('[data-ics]').addEventListener('click', () => downloadICS(it));
        wrap.appendChild(card);
      });

      resultEl.appendChild(wrap);
    }

    // è¼‰å…¥è³‡æ–™
    async function loadData() {
      try {
        const res = await fetch(DATA_URL, { cache: 'no-store' });
        allData = await res.json();
        loadStateEl.textContent = 'è³‡æ–™å·²è¼‰å…¥ï¼Œå¯è¼¸å…¥æ‰‹æ©Ÿè™Ÿç¢¼æŸ¥è©¢ã€‚';
      } catch (e) {
        console.error(e);
        loadStateEl.textContent = 'è³‡æ–™è¼‰å…¥å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚';
      }
    }

    // äº‹ä»¶ï¼šæŸ¥è©¢
    document.getElementById('searchForm').addEventListener('submit', e => {
      e.preventDefault();
      errorEl.textContent = '';
      resultEl.style.display = 'none';
      resultEl.innerHTML = '';

      const phoneInput = document.getElementById('phone').value.trim();
      const normalized = normalizePhone(phoneInput);

      if (!normalized) {
        errorEl.textContent = 'è«‹è¼¸å…¥æ‰‹æ©Ÿè™Ÿç¢¼ã€‚';
        return;
      }

      // åš´æ ¼ç”¨ã€Œå®Œæ•´è™Ÿç¢¼ã€æ¯”å°ï¼›è‹¥æƒ³é–‹æ”¾ã€Œåªè¼¸å…¥æœ«ä¸‰ç¢¼ã€æŸ¥è©¢ï¼Œå¯æ”¹æˆ endsWith(normalized)ã€‚
      const matches = allData.filter(x => normalizePhone(x.phone) === normalized);

      if (matches.length === 0) {
        errorEl.textContent = 'æŸ¥ç„¡æ­¤æ‰‹æ©Ÿè™Ÿç¢¼çš„è¨‚ä½ç´€éŒ„ã€‚';
        return;
      }

      // ä¾æ—¥æœŸæ™‚é–“æ’åºï¼ˆå¯è§£æçš„å„ªå…ˆï¼‰
      matches.sort((a, b) => {
        const da = parseDateTime(a.date, a.time);
        const db = parseDateTime(b.date, b.time);
        if (da && db) return da - db;
        if (da && !db) return -1;
        if (!da && db) return 1;
        return 0;
      });

      renderResults(matches, normalized);
    });

    loadData();
  </script>
</body>
</html>
