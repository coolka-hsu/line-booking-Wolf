<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>æŸ¥è©¢æˆ‘çš„è¨‚ä½</title>
  <style>
    /* é˜² iOS Safari è¼¸å…¥æ™‚è‡ªå‹•æ”¾å¤§ */
    html { -webkit-text-size-adjust: 100%; }
    input[type="tel"], button, select { font-size: 16px; }

    body {
      font-family: 'Noto Sans TC', sans-serif;
      background-color: #f5f5f5;
      padding: 2rem;
      color: #333;
    }
    h1 { font-size: 1.8rem; margin-bottom: 1rem; }
    form {
      background: #fff; padding: 1.5rem; border-radius: 10px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1); max-width: 520px; margin: 0 auto 1rem;
    }
    label { display: block; margin-top: 0.5rem; font-weight: bold; }
    input[type="tel"]{
      width: 98%; padding: 0.5rem; margin-top: 0.3rem;
      border: 1px solid #ccc; border-radius: 5px;
    }
    button {
      margin-top: 1rem; padding: 0.7rem 1.2rem; background-color: #4CAF50;
      color: #fff; border: none; border-radius: 5px; cursor: pointer; font-size: 16px;
    }
    .error { color: #d93025; margin-top: 0.8rem; }
    .muted { color: #666; font-size: .95rem; }
    .panel, .result {
      max-width: 760px; margin: 1rem auto; background: #fff; padding: 1.2rem;
      border-radius: 10px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    .cards { display: grid; grid-template-columns: repeat(auto-fill, minmax(320px, 1fr)); gap: 12px; }
    .card { border: 1px solid #eee; border-radius: 10px; padding: 12px; }
    .row { margin: .35rem 0; }
    .label { color:#555; display:inline-block; min-width: 6.5em; }
    .badge { display:inline-block; padding:2px 8px; border-radius:999px; background:#f0f0f0; font-size:.85rem; }
  </style>
</head>
<body>
  <h1>ğŸ” æŸ¥è©¢æˆ‘çš„è¨‚ä½</h1>

  <form id="searchForm">
    <div class="muted" id="loadState">è³‡æ–™è¼‰å…¥ä¸­â€¦</div>

    <label for="phone">æ‰‹æ©Ÿè™Ÿç¢¼ï¼š</label>
    <input type="tel" id="phone" placeholder="è«‹è¼¸å…¥æ‚¨çš„å®Œæ•´æ‰‹æ©Ÿè™Ÿç¢¼ï¼ˆç¬¦è™Ÿå¯ç•¥ï¼‰" required />

    <button type="submit">æŸ¥è©¢</button>
    <div class="error" id="error"></div>
  </form>

  <div class="result" id="result" style="display:none;"></div>

  <script>
    const DATA_URL = 'https://coolka-hsu.github.io/line-booking-Wolf/search_data.json';
    let allData = [];

    const loadStateEl = document.getElementById('loadState');
    const errorEl = document.getElementById('error');
    const resultEl = document.getElementById('result');

    // æ‰‹æ©Ÿæ ¼å¼åŒ–ï¼šç§»é™¤ç©ºç™½èˆ‡ç¬¦è™Ÿ
    function normalizePhone(str) {
      return (str || '').replace(/\D+/g, '');
    }

    // å°‡æ—¥æœŸèˆ‡æ™‚é–“è§£ææˆ JS Dateï¼ˆä¾›æ’åºï¼‰
    function parseDateTime(dateStr, timeStr) {
      const m = dateStr.trim().replace(/-/g,'/').match(/^(\d{4})\/(\d{1,2})\/(\d{1,2})$/);
      if (!m) return null;
      let [_, y, mo, d] = m;
      y = +y; mo = +mo; d = +d;

      let h = 0, min = 0;
      const t = (timeStr || '').trim();

      const zh = t.match(/^(ä¸Šåˆ|ä¸‹åˆ)\s*(\d{1,2})(?::(\d{2}))?$/);
      const en = t.match(/^(\d{1,2})(?::(\d{2}))?\s*(AM|PM)$/i);
      const plain = t.match(/^(\d{1,2}):(\d{2})$/);

      if (zh) {
        h = +zh[2]; min = +(zh[3] || 0);
        if (zh[1] === 'ä¸‹åˆ' && h < 12) h += 12;
        if (zh[1] === 'ä¸Šåˆ' && h === 12) h = 0;
      } else if (en) {
        h = +en[1]; min = +(en[2] || 0);
        const ap = en[3].toUpperCase();
        if (ap === 'PM' && h < 12) h += 12;
        if (ap === 'AM' && h === 12) h = 0;
      } else if (plain) {
        h = +plain[1]; min = +plain[2];
      } else {
        const dt = new Date(`${y}/${mo}/${d} ${t}`);
        if (!isNaN(dt)) return dt;
        return null;
      }
      return new Date(y, mo - 1, d, h, min, 0, 0);
    }

    // æ¸²æŸ“çµæœ
    function renderResults(items, phone) {
      const normalized = normalizePhone(phone);
      resultEl.innerHTML = '';
      resultEl.style.display = 'block';

      const header = document.createElement('div');
      header.className = 'panel';
      header.innerHTML = `<div><strong>æŸ¥è©¢é–€è™Ÿï¼š</strong>${normalized}ã€€<span class="badge">å…± ${items.length} ç­†</span></div>`;
      resultEl.appendChild(header);

      const wrap = document.createElement('div');
      wrap.className = 'cards';

      items.forEach(it => {
        const card = document.createElement('div');
        card.className = 'card';
        card.innerHTML = `
          <div class="row"><span class="label">ğŸ“… è¨‚ä½æ—¥æœŸï¼š</span>${it.date}</div>
          <div class="row"><span class="label">â° ç”¨é¤æ™‚æ®µï¼š</span>${it.time}</div>
          <div class="row"><span class="label">ğŸ§‘ è¨‚ä½å¤§åï¼š</span>${it.display_name || ''} å…ˆç”Ÿ/å°å§</div>
          <div class="row"><span class="label">ğŸ™â€â™‚ï¸ LINEåç¨±ï¼š</span>${it.line_name || ''}</div>
          <div class="row"><span class="label">ğŸ“ æ‰‹æ©Ÿè™Ÿç¢¼ï¼š</span>${it.phone}</div>
          <div class="row"><span class="label">ğŸ‘¨â€ğŸ‘©â€ğŸ‘§â€ğŸ‘¦ äººæ•¸ï¼š</span>${it.people}</div>
          <div class="row"><span class="label">ğŸ“ å‚™è¨»ï¼š</span>${it.note || 'ç„¡'}</div>
        `;
        wrap.appendChild(card);
      });

      resultEl.appendChild(wrap);
    }

    // è¼‰å…¥è³‡æ–™
    async function loadData() {
      try {
        const res = await fetch(DATA_URL, { cache: 'no-store' });
        allData = await res.json();
        loadStateEl.textContent = 'è³‡æ–™å·²è¼‰å…¥ï¼Œå¯è¼¸å…¥æ‰‹æ©Ÿè™Ÿç¢¼æŸ¥è©¢ã€‚';
      } catch (e) {
        console.error(e);
        loadStateEl.textContent = 'è³‡æ–™è¼‰å…¥å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚';
      }
    }

    // æŸ¥è©¢é€å‡º
    document.getElementById('searchForm').addEventListener('submit', e => {
      e.preventDefault();
      errorEl.textContent = '';
      resultEl.style.display = 'none';
      resultEl.innerHTML = '';

      // é€å‡ºå¾Œè®“è¼¸å…¥æ¡†å¤±ç„¦ï¼ŒiOS æœƒæŠŠç¸®æ”¾æ¢å¾©
      document.getElementById('phone').blur();

      const phoneInput = document.getElementById('phone').value.trim();
      const normalized = normalizePhone(phoneInput);

      if (!normalized) {
        errorEl.textContent = 'è«‹è¼¸å…¥æ‰‹æ©Ÿè™Ÿç¢¼ã€‚';
        return;
      }

      const matches = allData.filter(x => normalizePhone(x.phone) === normalized);

      if (matches.length === 0) {
        errorEl.textContent = 'æŸ¥ç„¡æ­¤æ‰‹æ©Ÿè™Ÿç¢¼çš„è¨‚ä½ç´€éŒ„ã€‚';
        return;
      }

      matches.sort((a, b) => {
        const da = parseDateTime(a.date, a.time);
        const db = parseDateTime(b.date, b.time);
        if (da && db) return da - db;
        if (da && !db) return -1;
        if (!da && db) return 1;
        return 0;
      });

      renderResults(matches, normalized);
    });

    loadData();
  </script>
</body>
</html>
