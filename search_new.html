<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>查詢我的訂位</title>
  <style>
    /* 防 iOS Safari 輸入時自動放大 */
    html { -webkit-text-size-adjust: 100%; }
    input[type="tel"], button, select { font-size: 16px; }

    body {
      font-family: 'Noto Sans TC', sans-serif;
      background-color: #f5f5f5;
      padding: 2rem;
      color: #333;
    }
    h1 { font-size: 1.8rem; margin-bottom: 1rem; }
    form {
      background: #fff; padding: 1.5rem; border-radius: 10px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1); max-width: 520px; margin: 0 auto 1rem;
    }
    label { display: block; margin-top: 0.5rem; font-weight: bold; }
    input[type="tel"]{
      width: 98%; padding: 0.5rem; margin-top: 0.3rem;
      border: 1px solid #ccc; border-radius: 5px;
    }
    button {
      margin-top: 1rem; padding: 0.7rem 1.2rem; background-color: #4CAF50;
      color: #fff; border: none; border-radius: 5px; cursor: pointer; font-size: 16px;
    }
    .error { color: #d93025; margin-top: 0.8rem; }
    .muted { color: #666; font-size: .95rem; }
    .panel, .result {
      max-width: 760px; margin: 1rem auto; background: #fff; padding: 1.2rem;
      border-radius: 10px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    .cards { display: grid; grid-template-columns: repeat(auto-fill, minmax(320px, 1fr)); gap: 12px; }
    .card { border: 1px solid #eee; border-radius: 10px; padding: 12px; }
    .row { margin: .35rem 0; }
    .label { color:#555; display:inline-block; min-width: 6.5em; }
    .badge { display:inline-block; padding:2px 8px; border-radius:999px; background:#f0f0f0; font-size:.85rem; }
    .actions { margin-top:.6rem; }
    .link-btn {
      display:inline-block; padding:.5rem .8rem; border-radius:8px; text-decoration:none;
      background:#efefef; border: none; cursor: pointer;
    }
  </style>
</head>
<body>
  <h1>🔍 查詢我的訂位</h1>

  <form id="searchForm">
    <div class="muted" id="loadState">資料載入中…</div>

    <label for="phone">手機號碼：</label>
    <input type="tel" id="phone" placeholder="請輸入您的完整手機號碼（符號可略）" required />

    <button type="submit">查詢</button>
    <div class="error" id="error"></div>
  </form>

  <div class="result" id="result" style="display:none;"></div>

  <script>
    const DATA_URL = 'https://coolka-hsu.github.io/line-booking-Wolf/search_data.json';
    const CAL_TITLE = '北宜32K 狼來了碳烤羊腿 用餐提醒';
    const CAL_DETAILS = '📌 阿義提醒您：這是您在【北宜32K 狼來了碳烤羊腿】的訂位。建議提前抵達！🔔 提醒建議：請將預設的「提前10分鐘通知」改為「提前２天通知」！';
    const CAL_LOCATION = '232新北市坪林區北宜公路七段32K';
    let allData = [];

    const loadStateEl = document.getElementById('loadState');
    const errorEl = document.getElementById('error');
    const resultEl = document.getElementById('result');

    /* ===== 工具 ===== */
    function normalizePhone(str) {
      return (str || '').replace(/\D+/g, '');
    }

    function parseDateTime(dateStr, timeStr) {
      const m = dateStr.trim().replace(/-/g,'/').match(/^(\d{4})\/(\d{1,2})\/(\d{1,2})$/);
      if (!m) return null;
      let [_, y, mo, d] = m;
      y = +y; mo = +mo; d = +d;

      let h = 0, min = 0;
      const t = (timeStr||'').trim();

      const zh = t.match(/^(上午|下午)\s*(\d{1,2})(?::(\d{2}))?$/);
      const en = t.match(/^(\d{1,2})(?::(\d{2}))?\s*(AM|PM)$/i);
      const plain = t.match(/^(\d{1,2}):(\d{2})$/);

      if (zh) {
        h = +zh[2]; min = +(zh[3] || 0);
        if (zh[1] === '下午' && h < 12) h += 12;
        if (zh[1] === '上午' && h === 12) h = 0;
      } else if (en) {
        h = +en[1]; min = +(en[2] || 0);
        const ap = en[3].toUpperCase();
        if (ap === 'PM' && h < 12) h += 12;
        if (ap === 'AM' && h === 12) h = 0;
      } else if (plain) {
        h = +plain[1]; min = +plain[2];
      } else {
        const dt = new Date(`${y}/${mo}/${d} ${t}`);
        if (!isNaN(dt)) return dt;
        return null;
      }
      return new Date(y, mo - 1, d, h, min, 0, 0);
    }

    function fmtICS(dt) {
      const pad = n => String(n).padStart(2, '0');
      return `${dt.getFullYear()}${pad(dt.getMonth()+1)}${pad(dt.getDate())}T${pad(dt.getHours())}${pad(dt.getMinutes())}00`;
    }

    /* ===== 產生 Google 日曆連結（網頁版） ===== */
    function createWebGCalLink(date, time) {
      const startDt = parseDateTime(date, time);
      if (!startDt) return '#';
      const endDt = new Date(startDt.getTime() + 2.5 * 60 * 60 * 1000);
      const params = new URLSearchParams({
        action: 'TEMPLATE',
        text: CAL_TITLE,
        dates: `${fmtICS(startDt)}/${fmtICS(endDt)}`,
        details: CAL_DETAILS,
        location: CAL_LOCATION
      });
      return `https://calendar.google.com/calendar/render?${params.toString()}`;
    }

    /* ===== iOS 深連結（有安裝 App 會直接帶起）===== */
    function createIOSDeepLink(date, time) {
      const startDt = parseDateTime(date, time);
      if (!startDt) return null;
      const endDt = new Date(startDt.getTime() + 2.5 * 60 * 60 * 1000);
      const params = new URLSearchParams({
        action: 'create',
        text: CAL_TITLE,
        dates: `${fmtICS(startDt)}/${fmtICS(endDt)}`,
        details: CAL_DETAILS,
        location: CAL_LOCATION
      });
      return `comgooglecalendar://?${params.toString()}`;
    }

    /* ===== 按哪一筆就開哪一筆：優先 App，否則退回網頁 ===== */
    function openCalendar(date, time) {
      const ua = navigator.userAgent || '';
      const isIOS = /iPad|iPhone|iPod/i.test(ua);
      const webUrl = createWebGCalLink(date, time);

      if (isIOS) {
        const iosUrl = createIOSDeepLink(date, time);
        if (iosUrl) {
          // 嘗試喚起 App；若無 App，800ms 後退回網頁
          const ts = Date.now();
          window.location.href = iosUrl;
          setTimeout(() => {
            // 若沒有跳走（沒有安裝 App），再開網頁版
            if (Date.now() - ts < 1800 && webUrl && webUrl !== '#') {
              window.open(webUrl, '_blank');
            }
          }, 800);
          return;
        }
      }

      // Android 與其他：用網頁連結（多數情況下 Chrome/Android 也會引導 App）
      if (webUrl && webUrl !== '#') window.open(webUrl, '_blank');
    }

    /* ===== 渲染結果卡片 ===== */
    function renderResults(items, phone) {
      const normalized = normalizePhone(phone);
      resultEl.innerHTML = '';
      resultEl.style.display = 'block';

      const header = document.createElement('div');
      header.className = 'panel';
      header.innerHTML = `<div><strong>查詢門號：</strong>${normalized}　<span class="badge">共 ${items.length} 筆</span></div>`;
      resultEl.appendChild(header);

      const wrap = document.createElement('div');
      wrap.className = 'cards';

      items.forEach(it => {
        const card = document.createElement('div');
        card.className = 'card';
        card.innerHTML = `
          <div class="row"><span class="label">📅 訂位日期：</span>${it.date}</div>
          <div class="row"><span class="label">⏰ 用餐時段：</span>${it.time}</div>
          <div class="row"><span class="label">🧑 訂位大名：</span>${it.display_name || ''} 先生/小姐</div>
          <div class="row"><span class="label">🙍‍♂️ LINE名稱：</span>${it.line_name || ''}</div>
          <div class="row"><span class="label">📞 手機號碼：</span>${it.phone}</div>
          <div class="row"><span class="label">👨‍👩‍👧‍👦 人數：</span>${it.people}</div>
          <div class="row"><span class="label">📝 備註：</span>${it.note || '無'}</div>
          <div class="actions">
            <button type="button" class="link-btn" data-gcal="1" data-date="${it.date}" data-time="${it.time}">
              📆 加到 Google 日曆
            </button>
          </div>
        `;
        wrap.appendChild(card);
      });

      resultEl.appendChild(wrap);
    }

    /* ===== 資料載入 ===== */
    async function loadData() {
      try {
        const res = await fetch(DATA_URL, { cache: 'no-store' });
        allData = await res.json();
        loadStateEl.textContent = '資料已載入，可輸入手機號碼查詢。';
      } catch (e) {
        console.error(e);
        loadStateEl.textContent = '資料載入失敗，請稍後再試。';
      }
    }

    /* ===== 事件：查詢送出 ===== */
    document.getElementById('searchForm').addEventListener('submit', e => {
      e.preventDefault();
      errorEl.textContent = '';
      resultEl.style.display = 'none';
      resultEl.innerHTML = '';

      // 送出後讓輸入框失焦，iOS 會把縮放恢復原狀
      document.getElementById('phone').blur();

      const phoneInput = document.getElementById('phone').value.trim();
      const normalized = normalizePhone(phoneInput);

      if (!normalized) {
        errorEl.textContent = '請輸入手機號碼。';
        return;
      }

      const matches = allData.filter(x => normalizePhone(x.phone) === normalized);

      if (matches.length === 0) {
        errorEl.textContent = '查無此手機號碼的訂位紀錄。';
        return;
      }

      matches.sort((a, b) => {
        const da = parseDateTime(a.date, a.time);
        const db = parseDateTime(b.date, b.time);
        if (da && db) return da - db;
        if (da && !db) return -1;
        if (!da && db) return 1;
        return 0;
      });

      renderResults(matches, normalized);
    });

    /* ===== 事件代理：點哪一筆就開該筆（日曆 App 優先，否則開網頁） ===== */
    document.addEventListener('click', (e) => {
      const btn = e.target.closest('[data-gcal]');
      if (!btn) return;
      const { date, time } = btn.dataset;
      openCalendar(date, time);
    });

    loadData();
  </script>
</body>
</html>
