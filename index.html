<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <title>LINE å®šä½ç³»çµ±</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <style>
    body { font-family: sans-serif; padding: 20px; background: #f5f5f5; }
    input, select, textarea { width: 100%; padding: 8px; margin-top: 8px; }
    .hidden { display: none; }
    .form-group { margin-bottom: 16px; }
    button { padding: 10px 20px; background: #28a745; color: #fff; border: none; border-radius: 6px; cursor: pointer; }
    button[disabled] { opacity: .6; cursor: not-allowed; }
    #timeOptions button { display: block; margin: 5px 0; width: 100%; }
    .muted { color:#666; font-size: 14px; }
  </style>
</head>
<body>
  <h2>ğŸ“… è«‹é¸æ“‡æƒ³è¦é ç´„çš„æ™‚é–“</h2>
  <div id="timeOptions">è¼‰å…¥ä¸­......è¼‰å…¥æ™‚é–“é è¨ˆ 5 ç§’</div>

  <form id="bookingForm" class="hidden">
    <h3>è«‹å¡«å¯«ä»¥ä¸‹è³‡è¨Š</h3>

    <div class="form-group">
      <label>ç”¨é¤æ—¥æœŸ</label>
      <input type="text" name="date" readonly>
    </div>

    <div class="form-group">
      <label>ç”¨é¤æ™‚æ®µ</label>
      <input type="text" name="time" readonly>
    </div>

    <div class="form-group">
      <label>è¨‚ä½å¤§å</label>
      <input type="text" name="display_name" placeholder="è«‹å¡«å¯«æ‚¨çš„å§“å" required>
    </div>

    <div class="form-group">
      <label>Lineç¤¾ç¾¤ID</label>
      <input type="text" name="line_name" placeholder="è«‹å¡«å¯«æ‚¨åœ¨ç¤¾ç¾¤ä¸­çš„åç¨±" required>
    </div>

    <div class="form-group">
      <label>æ‰‹æ©Ÿè™Ÿç¢¼</label>
      <input type="tel" name="phone" placeholder="è«‹å¡«å¯«æ­£ç¢ºè™Ÿç¢¼ï¼Œé¿å…ç„¡æ³•è¯ç¹«" required>
      <div class="muted">ï¼ˆæäº¤å¾Œç³»çµ±æœƒä¿ç•™å‰å° 0ï¼Œè³‡æ–™åº«èˆ‡è©¦ç®—è¡¨éƒ½ä»¥æ–‡å­—å„²å­˜ï¼‰</div>
    </div>

    <div class="form-group">
      <label>ç”¨é¤äººæ•¸</label>
      <select name="adults" required>
        <option value="">è«‹é¸æ“‡å¤§äººæ•¸é‡</option>
        <option value="1">å¤§äºº(1)</option>
        <option value="2">å¤§äºº(2)</option>
        <option value="3">å¤§äºº(3)</option>
        <option value="4">å¤§äºº(4)</option>
        <option value="5">å¤§äºº(5)</option>
        <option value="6">å¤§äºº(6)</option>
        <option value="7">å¤§äºº(7)</option>
        <option value="8">å¤§äºº(8)</option>
        <option value="9">å¤§äºº(9)</option>
        <option value="10">å¤§äºº(10)</option>
      </select>
      <select name="children" required>
        <option value="0">å°æœ‹å‹(0)</option>
        <option value="1">å°æœ‹å‹(1)</option>
        <option value="2">å°æœ‹å‹(2)</option>
        <option value="3">å°æœ‹å‹(3)</option>
        <option value="4">å°æœ‹å‹(4)</option>
        <option value="5">å°æœ‹å‹(5)</option>
        <option value="6">å°æœ‹å‹(6)</option>
        <option value="7">å°æœ‹å‹(7)</option>
        <option value="8">å°æœ‹å‹(8)</option>
        <option value="9">å°æœ‹å‹(9)</option>
        <option value="10">å°æœ‹å‹(10)</option>
      </select>
      <small>ç¸½äººæ•¸è«‹å‹¿è¶…é 10 ä½</small>
    </div>

    <div class="form-group">
      <label>å‚™è¨»</label>
      <textarea name="note" placeholder="è‹¥æœ‰å°æœ‹å‹è«‹è¨»è¨˜å¹´é½¡"></textarea>
    </div>

    <button id="submitBtn" type="submit">é€å‡ºé ç´„</button>
  </form>

  <div id="resultMsg" style="margin-top: 20px;"></div>

  <script>
    // === ä½ çš„è¨­å®š ===
    const liffId = "2007778847-4d7bwNEV"; // ä½ çš„ LIFF ID
    const getOpenSlotsUrl = "https://script.google.com/macros/s/AKfycbzGbLz5op4vTp_3ypxBt0S2kSgKoeI8hfnMfwCKF10IUS-jrsjHUKO_6nWy5CNWrivqeQ/exec"; // GAS ä»£ç†ï¼šè®€æ™‚æ®µ
    const postUrl = "https://script.google.com/macros/s/AKfycbxrX6Yuhh8LM0jJ0Xc-i_sw1lN0Wvc9Ge_MUWCgmLsm51N1NcrZSudnQIkOEaBJdAoiZA/exec"; // GAS å¯«å…¥ç«¯é»ï¼ˆä¾ä½ å¯¦éš›éƒ¨ç½²èª¿æ•´ï¼‰

    let profile = {};
    let selected = {};
    let submitting = false;

    // === LIFF è¨Šæ¯ï¼šçµ„å­—ä¸² ===
    function buildBookingMessage({ date, time, total, phone }) {
      const [yyyy, mm, dd] = (date || "").split("-");
      const last3 = (phone || "").toString().slice(-3);
      return `ã€é˜¿ç¾©å¸«ï¼Œæˆ‘é å®šäº†${Number(mm)}æœˆ${Number(dd)}æ—¥ ${time} ${total}äºº æ‰‹æ©Ÿå°¾ç¢¼${last3}ã€‘`;
    }

    // === LIFF è¨Šæ¯ï¼šé€åˆ°èŠå¤©å®¤ / åˆ†äº«é¢æ¿ / è¤‡è£½å‚™æ´ ===
    async function trySendChatMessage(text) {
      try {
        const inClient = liff.isInClient();
        const ctx = liff.getContext() || {};
        const ctxType = ctx.type; // utou, room, group, none

        if (inClient && ["utou", "room", "group"].includes(ctxType)) {
          await liff.sendMessages([{ type: "text", text }]);
          return { ok: true, via: "sendMessages" };
        }

        if (liff.isApiAvailable("shareTargetPicker")) {
          const res = await liff.shareTargetPicker([{ type: "text", text }]);
          if (res) return { ok: true, via: "shareTargetPicker" };
        }

        try {
          await navigator.clipboard.writeText(text);
          return { ok: false, via: "copied" };
        } catch (_) {
          return { ok: false, via: "fallback" };
        }
      } catch (err) {
        console.error("ç™¼é€èŠå¤©å®¤è¨Šæ¯å¤±æ•—ï¼š", err);
        return { ok: false, via: "error", err };
      }
    }

    async function afterBookingSuccess(payload) {
      const msg = buildBookingMessage({
        date: payload.date,
        time: payload.time,
        total: (payload.adults || 0) + (payload.children || 0),
        phone: payload.phone
      });

      const r = await trySendChatMessage(msg);

      if (!r.ok) {
        try {
          await navigator.clipboard.writeText(msg);
          alert("å·²è¤‡è£½é€šçŸ¥è¨Šæ¯ï¼Œè«‹è²¼åˆ°ç¤¾ç¾¤é€šçŸ¥é˜¿ç¾©å¸«ï¼š\n\n" + msg);
        } catch (_) {
          alert("è«‹æŠŠä»¥ä¸‹è¨Šæ¯è²¼åˆ°ç¤¾ç¾¤é€šçŸ¥é˜¿ç¾©å¸«ï¼š\n\n" + msg);
        }
      }

      // æœ€å¾Œå°åˆ°æˆåŠŸé 
      window.location.href = "https://coolka-hsu.github.io/line-booking-Wolf/success.html";
    }

    async function init() {
      await liff.init({ liffId });
      if (!liff.isLoggedIn()) liff.login();

      profile = await liff.getProfile();

      try {
        const res = await fetch(getOpenSlotsUrl);
        const times = await res.json();
        const container = document.getElementById("timeOptions");
        container.innerHTML = "";

        if (!Array.isArray(times) || times.length === 0) {
          container.innerHTML = `
            <div style="padding: 20px; background: #fffbe7; border: 1px solid #ccc; border-radius: 8px;">
              <strong>å¾ˆæŠ±æ­‰ï¼Œæœ¬æœˆè¨‚ä½çš†å·²å…¨æ•¸é å®šå®Œç•¢ï¼Œ</strong><br>
              ä¸‹å€‹æœˆé–‹æ”¾è¨‚ä½æ™‚é–“ï¼Œè«‹é—œæ³¨<br>
              <strong>
                <a href="https://line.me/ti/g2/d94EbuAl2Ts6wmTg-fM6qr4b7Bwpj6c7MDZ5Ug?utm_source=invitation&utm_medium=link_copy&utm_campaign=default" target="_blank" style="color: #d2691e; text-decoration: underline;">
                  ã€åŒ—å®œ32K "ç‹¼ä¾†äº†ç¢³çƒ¤ç¾Šè…¿"ã€‘LINEç¤¾ç¾¤
                </a>
              </strong>ï¼Œè¬è¬ï¼
            </div>
          `;
          return;
        }

        // å¯è¦–éœ€è¦éæ¿¾ statusï¼ˆå‡è¨­ç©ºå­—ä¸² / null æ‰æ˜¯å¯é ç´„ï¼‰
        const available = times.filter(t => !t.status || String(t.status).trim() === "");

        if (available.length === 0) {
          container.innerHTML = `
            <div style="padding: 20px; background: #fffbe7; border: 1px solid #ccc; border-radius: 8px;">
              <strong>å¾ˆæŠ±æ­‰ï¼Œæœ¬æœˆè¨‚ä½çš†å·²å…¨æ•¸é å®šå®Œç•¢ï¼Œ</strong><br>
              ä¸‹å€‹æœˆé–‹æ”¾è¨‚ä½æ™‚é–“ï¼Œè«‹é—œæ³¨<br>
              <strong>
                <a href="https://line.me/ti/g2/d94EbuAl2Ts6wmTg-fM6qr4b7Bwpj6c7MDZ5Ug?utm_source=invitation&utm_medium=link_copy&utm_campaign=default" target="_blank" style="color: #d2691e; text-decoration: underline;">
                  ã€åŒ—å®œ32K "ç‹¼ä¾†äº†ç¢³çƒ¤ç¾Šè…¿"ã€‘LINEç¤¾ç¾¤
                </a>
              </strong>ï¼Œè¬è¬ï¼
            </div>
          `;
          return;
        }

        available.forEach(t => {
          const btn = document.createElement("button");
          btn.textContent = `${t.date} ${t.time}`;
          btn.onclick = () => {
            selected = t;
            document.querySelector('input[name="date"]').value = t.date;
            document.querySelector('input[name="time"]').value = t.time;
            document.getElementById("bookingForm").classList.remove("hidden");
            window.scrollTo(0, document.body.scrollHeight);
          };
          container.appendChild(btn);
        });
      } catch (err) {
        console.error("è¼‰å…¥æ™‚æ®µå¤±æ•—ï¼š", err);
        document.getElementById("timeOptions").innerHTML = "âŒ ç„¡æ³•è¼‰å…¥è³‡æ–™ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚";
      }
    }

    document.getElementById("bookingForm").addEventListener("submit", async (e) => {
      e.preventDefault();
      if (submitting) return; // é˜²é‡è¤‡é€å‡º
      submitting = true;

      const submitBtn = document.getElementById("submitBtn");
      submitBtn.disabled = true;
      submitBtn.textContent = "é€å‡ºä¸­â€¦";

      const form = new FormData(e.target);
      const adults = parseInt(form.get("adults")) || 0;
      const children = parseInt(form.get("children")) || 0;
      const total = adults + children;

      if (total > 10) {
        document.getElementById("resultMsg").textContent = "âŒ äººæ•¸è¶…éåä½ï¼Œè«‹é‡æ–°é¸æ“‡";
        submitBtn.disabled = false;
        submitBtn.textContent = "é€å‡ºé ç´„";
        submitting = false;
        return;
      }

      const data = {
        uid: profile.userId,
        name: profile.displayName,
        display_name: form.get("display_name"),
        line_name: form.get("line_name"),
        phone: form.get("phone"),
        adults,
        children,
        note: form.get("note"),
        date: selected.date,
        time: selected.time
      };

      try {
        const res = await fetch(postUrl, {
          method: "POST",
          body: JSON.stringify(data)
        });

        const result = await res.json();
        document.getElementById("resultMsg").textContent = result.message || "";

        if (result.success) {
          await afterBookingSuccess(data); // å…ˆç™¼è¨Šæ¯ï¼Œå†è·³è½‰
        } else {
          submitBtn.disabled = false;
          submitBtn.textContent = "é€å‡ºé ç´„";
          submitting = false;
        }
      } catch (err) {
        console.error("é ç´„éŒ¯èª¤ï¼š", err);
        document.getElementById("resultMsg").textContent = "âŒ ç™¼ç”ŸéŒ¯èª¤ï¼Œè«‹ç¨å¾Œå†è©¦";
        submitBtn.disabled = false;
        submitBtn.textContent = "é€å‡ºé ç´„";
        submitting = false;
      }
    });

    init();
  </script>
</body>
</html>
