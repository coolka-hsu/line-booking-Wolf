<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <title>LINE å®šä½ç³»çµ±ï¼ˆè³‡æ–™åº«ç‰ˆï¼‰</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <style>
    body { font-family: sans-serif; padding: 20px; background: #f5f5f5; }
    input, select, textarea { width: 100%; padding: 8px; margin-top: 8px; }
    .hidden { display: none; }
    .form-group { margin-bottom: 16px; }
    button { padding: 10px 20px; background: #28a745; color: #fff; border: none; border-radius: 6px; cursor: pointer; }
    #timeOptions button { display: block; margin: 5px 0; width: 100%; }
  </style>
</head>
<body>
  <h2>ğŸ“… è«‹é¸æ“‡æƒ³è¦é ç´„çš„æ™‚é–“</h2>
  <div id="timeOptions">è¼‰å…¥ä¸­......è«‹ç¨å€™</div>

  <form id="bookingForm" class="hidden">
    <h3>è«‹å¡«å¯«ä»¥ä¸‹è³‡è¨Š</h3>
    <div class="form-group"><label>ç”¨é¤æ—¥æœŸ</label><input type="text" name="date" readonly></div>
    <div class="form-group"><label>ç”¨é¤æ™‚æ®µ</label><input type="text" name="time" readonly></div>
    <div class="form-group"><label>è¨‚ä½å¤§å</label><input type="text" name="display_name" required></div>
    <div class="form-group"><label>Lineç¤¾ç¾¤ID</label><input type="text" name="line_name" required></div>
    <div class="form-group"><label>æ‰‹æ©Ÿè™Ÿç¢¼</label><input type="tel" name="phone" pattern="0[0-9]{8,}" required></div>
    <div class="form-group">
      <label>ç”¨é¤äººæ•¸</label>
      <select name="adults" required>
        <option value="">è«‹é¸æ“‡å¤§äººæ•¸é‡</option>
        <option value="1">å¤§äºº(1)</option><option value="2">å¤§äºº(2)</option><option value="3">å¤§äºº(3)</option>
        <option value="4">å¤§äºº(4)</option><option value="5">å¤§äºº(5)</option><option value="6">å¤§äºº(6)</option>
        <option value="7">å¤§äºº(7)</option><option value="8">å¤§äºº(8)</option><option value="9">å¤§äºº(9)</option><option value="10">å¤§äºº(10)</option>
      </select>
      <select name="children" required>
        <option value="0">å°æœ‹å‹(0)</option><option value="1">å°æœ‹å‹(1)</option><option value="2">å°æœ‹å‹(2)</option>
        <option value="3">å°æœ‹å‹(3)</option><option value="4">å°æœ‹å‹(4)</option><option value="5">å°æœ‹å‹(5)</option>
        <option value="6">å°æœ‹å‹(6)</option><option value="7">å°æœ‹å‹(7)</option><option value="8">å°æœ‹å‹(8)</option>
        <option value="9">å°æœ‹å‹(9)</option><option value="10">å°æœ‹å‹(10)</option>
      </select>
      <small>ç¸½äººæ•¸è«‹å‹¿è¶…é 10 ä½</small>
    </div>
    <div class="form-group"><label>å‚™è¨»</label><textarea name="note"></textarea></div>
    <button type="submit">é€å‡ºé ç´„</button>
  </form>

  <div id="resultMsg" style="margin-top: 20px;"></div>

  <script>
    const liffId = "2007778847-o44AJR30";
    const supabaseUrl = "https://tqxkicmuqbdtjwydasov.supabase.co";
    const supabaseKey = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InRxeGtpY211cWJkdGp3eWRhc292Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTMzMzk3NjksImV4cCI6MjA2ODkxNTc2OX0.rL2lnqxXy2nOrki1s40K0VkeClRLfiJwMKD33QjFUJg"; // è«‹ä¿ç•™åŸæœ¬æœ‰æ•ˆ key
    const postUrl = "https://script.google.com/macros/s/AKfycbxrX6Yuhh8LM0jJ0Xc-i_sw1lN0Wvc9Ge_MUWCgmLsm51N1NcrZSudnQIkOEaBJdAoiZA/exec";

    let profile = {};
    let selected = {};

    async function init() {
      await liff.init({ liffId });
      if (!liff.isLoggedIn()) liff.login();
      profile = await liff.getProfile();

      try {
        const res = await fetch(`${supabaseUrl}/rest/v1/open_slots?select=date,time,status,timestamp`, {
          headers: {
            apikey: supabaseKey,
            Authorization: `Bearer ${supabaseKey}`
          }
        });
        const data = await res.json();
        const container = document.getElementById("timeOptions");
        container.innerHTML = "";

        const available = Array.isArray(data) ? data.filter(slot => !slot.status || slot.status === "") : [];
        if (available.length === 0) {
          container.innerHTML = `<div style="padding:20px;background:#fffbe7;border:1px solid #ccc;border-radius:8px;">
            <strong>å¾ˆæŠ±æ­‰ï¼Œæœ¬æœˆè¨‚ä½çš†å·²å…¨æ•¸é å®šå®Œç•¢ï¼Œ</strong><br>è«‹æŒçºŒé—œæ³¨ LINE ç¤¾ç¾¤ï¼Œè¬è¬ï¼
          </div>`;
          return;
        }

        available.forEach(slot => {
          const btn = document.createElement("button");
          btn.textContent = `${slot.date} ${slot.time}`;
          btn.onclick = () => {
            selected = slot;
            document.querySelector('input[name="date"]').value = slot.date;
            document.querySelector('input[name="time"]').value = slot.time;
            document.getElementById("bookingForm").classList.remove("hidden");
            window.scrollTo(0, document.body.scrollHeight);
          };
          container.appendChild(btn);
        });

      } catch (err) {
        console.error("âŒ Supabase è¼‰å…¥å¤±æ•—", err);
        document.getElementById("timeOptions").innerHTML = "âŒ ç„¡æ³•è¼‰å…¥è³‡æ–™ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚";
      }
    }

    document.getElementById("bookingForm").addEventListener("submit", async (e) => {
      e.preventDefault();
      const form = new FormData(e.target);
      const adults = parseInt(form.get("adults")) || 0;
      const children = parseInt(form.get("children")) || 0;
      const total = adults + children;

      if (total > 10) {
        document.getElementById("resultMsg").textContent = "âŒ äººæ•¸è¶…éåä½ï¼Œè«‹é‡æ–°é¸æ“‡";
        return;
      }

      const payload = {
        uid: profile.userId,
        name: profile.displayName,
        display_name: form.get("display_name"),
        line_name: form.get("line_name"),
        phone: form.get("phone"),
        adults,
        children,
        people: total,
        note: form.get("note"),
        date: selected.date,
        time: selected.time
      };

      try {
        const res = await fetch(postUrl, {
          method: "POST",
          body: JSON.stringify(payload)
        });
        const result = await res.json();
        document.getElementById("resultMsg").textContent = result.message;

        if (result.success) {
          window.location.href = "https://coolka-hsu.github.io/line-booking-Wolf/success.html";
        }
      } catch (err) {
        document.getElementById("resultMsg").textContent = "âŒ ç™¼ç”ŸéŒ¯èª¤ï¼Œè«‹ç¨å¾Œå†è©¦";
        console.error("âŒ é ç´„éŒ¯èª¤", err);
      }
    });

    init();
  </script>
</body>
</html>
